name: "Tagged-release"

on:
  push:
    branches::
        - 'master'
  pull_request:
    branches::
        - 'master'
jobs:

  build: 
    name: "Build"  
    runs-on: windows-latest 
    steps:
      ##CHECKOUT
      - uses: actions/checkout@v3
      
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1.0.5
        
      - name: Add source
        run: |
            dotnet nuget add source "https://nuget.bepinex.dev/v3/index.json" --name baget 

      - name: Navigate to Workspace
        run: cd $GITHUB_WORKSPACE

      - name: Restore Packages
        run: nuget restore QuickPing.sln

      - name: Build Solution
        run: |
          msbuild.exe QuickPing.sln /p:platform="Any CPU" /p:configuration="Release"
  tagged-release:
    name: "Tagged Release"
    runs-on: "ubuntu-latest"
    needs: build
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      ##DOTNET SETUP 3.1.x
      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '3.1.x'
          
      - name: Extract owner and repo
        uses: jungwinter/split@v1
        id: repo
        with:
          seperator: '/'
          msg: ${{ github.repository }}
          
      - name: Allow Unsecure
        run: |
          echo "ACTIONS_ALLOW_UNSECURE_COMMANDS=true" >> $GITHUB_ENV          
      - name: "Build & test"
        run: |
          echo "unsecure done!"
          
      ##GitVersion SETUP
      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v0.9.15
        with:
            versionSpec: '5.x'
          
      ##GitVersion EXECUTE
      - name: Determine Version
        uses: gittools/actions/gitversion/execute@v0.9.15
        id: gitversion
        with:
          useConfigFile: true
          updateAssemblyInfo: true
          updateAssemblyInfoFilename: QuickPing/Properties/AssemblyInfo.cs

      ##GitRelease SETUP
      - uses: gittools/actions/gitreleasemanager/setup@v0.9.15
        name: Install GitReleaseManager
        with:
          versionSpec: '0.13.x'
        
        
      ##GitRelease CREATE
      - name: Create release with GitReleaseManager
        uses: gittools/actions/gitreleasemanager/create@v0.9.15
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          owner: ${{ steps.repo.outputs._0 }}
          repository: ${{ steps.repo.outputs._1 }}
          milestone: ${{ steps.gitversion.outputs.majorMinorPatch }}
          name: 'Release ${{ steps.gitversion.outputs.semVer }}'
          assets:  |
            QuickPing/Package/plugins/QuickPing.dll
           
      ##GitRelease PUBLISH 
      - uses: gittools/actions/gitreleasemanager/publish@v0.9.15
        name: Publish release with GitReleaseManager
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          owner: ${{ steps.repo.outputs._0 }}
          repository: ${{ steps.repo.outputs._1 }}   
          milestone: ${{ steps.gitversion.outputs.majorMinorPatch }} 
          tagName: ${{ steps.gitversion.outputs.semVer }}
  publish-modpackage:
    runs-on: ubuntu-latest
    needs: tagged-release
    steps:
      # Use checkout to publish the files in your repo
      - uses: ciiiii/toml-editor@1.0.0
        with:
            file: "QuickPing/thunderstore.toml"
            key: "package.versionNumber"
            value: ${{ steps.gitversion.outputs.majorMinorPatch }} 
      - run: |
         ls
         wget https://github.com/thunderstore-io/thunderstore-cli/releases/download/0.1.6/tcli-0.1.6-linux-x64.tar.gz
         tar -xf tcli-0.1.6-linux-x64.tar.gz
         mv ./tcli-0.1.6-linux-x64/tcli QuickPing/tcli
         cd QuickPing
         ./tcli publish --token ${{ secrets.THUNDERSTORE_TOKEN }}